

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="对rsync做详细介绍，并结合inotify-tools实现实时同步，并分析其缺点，然后对sersync做简单介绍，其实感觉并没什么鸟用，以后介绍更强大的实现同步工具吧">

<title>rsync + inotify 实现实时同步</title>

<!-- favicon -->
<link rel="shortcut icon" href="./favicon.ico" type="image/icon">
<link rel="icon" href="./favicon.ico" type="/image/icon">
<link rel="stylesheet" type="text/css" href="/stylesheets/base.css">
<link rel="stylesheet" type="text/css" href="/stylesheets/simplePagination.css">

<script type="text/javascript" src="/javascripts/jquery.js"></script>

<!--[if lt IE 9]>
<script src="/javascripts/html5shiv.js"></script>
<![endif]-->

    <link rel="stylesheet" type="text/css" href="/stylesheets/markdownreader.css">
<link rel="stylesheet" type="text/css" href="/stylesheets/pygments_monokai.css">
<link rel="stylesheet" type="text/css" href="/stylesheets/code_block.css">
</head>

<body>
    <header id="l-header">
    <div class="container">
        <div class="row logo">
            <div class="col-lg-7">
                <h1>SanDow</h1>
            </div>


            <div class="col-lg-5">
                <p>On the way to death</p>
                <p>On the way of learning</p>
            </div>
        </div>

        <div class="row navicon">
            <a href=""><i class="fa fa-navicon"></i></a>
        </div>

        <div class="row navbar">
            <nav class="col-lg-8 col-md-8 col-xs-12">
                <ul class="row">
                    <li class="col-lg-3"><a href="/">HOME</a></li>
                    <li class="col-lg-3">
                        <ul class="subnav">
                            <a href="javascript:void(0)">POST</a>
                            <li><a href="/category">CATEGORY</a></li>
                            <li><a href="/tag">TAG</a></li>
                        </ul>
                    </li>
                    <li class="col-lg-3"><a href="/about">ABOUT</a></li>
                    <li class="col-lg-3"><a href="/building">PLAY GROUND</a></li>
                </ul>
            </nav>

            <div class="search col-lg-4 col-md-4 col-xs-12">
                <label for="search"></label>
                <input id="search" name="serach" type="text" placeholder="Dummy Search">
                <i class="fa fa-search"></i>
            </div>
        </div>
    </div>
</header>

    <div class="container">
        <div class="row">
            <div id="markdown-container" class="col-lg-9">
                <header>
                    <p id="postTitle">rsync + inotify 实现实时同步</p>
                    
                    <ul class="tags clearfix">
                        
                        <li><i class="fa fa-tag"></i> linux</li>
                        
                    </ul>
                    
                    <p id="postMeta">posted on 09 Nov 2015 under category <a href="/category/">linux</a></p>

                </header>

                <h1 id="主机规划">主机规划</h1>

<table><thead>
<tr>
<th style="text-align: left">服务器</th>
<th style="text-align: left">外网IP</th>
<th style="text-align: left"></th>
<th style="text-align: left">内网IP</th>
<th style="text-align: left">主机名称</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">A1-nginx 负载服务器</td>
<td style="text-align: left">10.0.0.5/24</td>
<td style="text-align: left"></td>
<td style="text-align: left">127.16.1.5/24</td>
<td style="text-align: left">lb01</td>
</tr>
<tr>
<td style="text-align: left">A2-nginx 负载服务器</td>
<td style="text-align: left">10.0.0.6/24</td>
<td style="text-align: left"></td>
<td style="text-align: left">127.16.1.6/24</td>
<td style="text-align: left">lb02</td>
</tr>
<tr>
<td style="text-align: left">B1-apache软件web服务器</td>
<td style="text-align: left">10.0.0.7/24</td>
<td style="text-align: left"></td>
<td style="text-align: left">127.16.1.7/24</td>
<td style="text-align: left">web02</td>
</tr>
<tr>
<td style="text-align: left">B2-apache软件web服务器</td>
<td style="text-align: left">10.0.0.8/24</td>
<td style="text-align: left"></td>
<td style="text-align: left">127.16.1.8/24</td>
<td style="text-align: left">web01</td>
</tr>
<tr>
<td style="text-align: left">C3-My Sql 数据库服务器</td>
<td style="text-align: left"><code>10.0.0.51/24</code></td>
<td style="text-align: left"></td>
<td style="text-align: left">127.16.1.51/24</td>
<td style="text-align: left">Db01</td>
</tr>
<tr>
<td style="text-align: left">C1-NFS 存储服务器</td>
<td style="text-align: left"><code>10.0.0.31/24</code></td>
<td style="text-align: left"></td>
<td style="text-align: left">127.16.1.31/24</td>
<td style="text-align: left">NFS01</td>
</tr>
<tr>
<td style="text-align: left">C2-rsync 数据库服务器</td>
<td style="text-align: left"><code>10.0.0.41/24</code></td>
<td style="text-align: left"></td>
<td style="text-align: left">127.16.1.41/24</td>
<td style="text-align: left">Backup</td>
</tr>
<tr>
<td style="text-align: left">X-管理服务器</td>
<td style="text-align: left"><code>10.0.0.61/24</code></td>
<td style="text-align: left"></td>
<td style="text-align: left">127.16.1.61/24</td>
<td style="text-align: left">m01</td>
</tr>
</tbody></table>

<blockquote>
<p>红色仅为虚拟机中测试所用 <br/>
机房根据实际需求配置</p>
</blockquote>

<h2 id="克隆虚拟机并配置网卡">克隆虚拟机并配置网卡</h2>

<ol>
<li><p>编辑eth0的配置文件：<code>vi /etc/sysconfig/network-scripts/ifcfg-eth0</code>，删除HWADDR地址那一行及UUID的行如下：</p>

<p>HWADDR=00:0c:29:08:28:9f<br>
UUID=cee39dbb-6a10-4425-9daf-768b6e79a9c9</p></li>
<li><p>清空 /etc/udev/rules.d/70-persistent-net.rules</p></li>
<li><p>重启</p></li>
</ol>

<h2 id="rsync-数据库服务器">RSYNC 数据库服务器</h2>

<p>rsync, (remote synchronize) 是一个实现同步功能的软件，它在同步文件的同时，可以保持原来文件的权限，时间，软硬链接等附加信息。 rsync是用rsync 算法提供了一个客户机和远程文件服务器的文件同步的快速方法，而且可以通过ssh方式来传输文件，这样保密也非常好。主要用于远程数据备份与同步。 可以实现全备及增量备份，也可以本地数据同步。 在Centos5中rsync的版本是2.X，是把所有文件比对一遍后进行同步。在CentOs6中rsync的版本是3.0，是一边比对差异一边进行同步。而这里我们用的是3.0</p>

<p>首先检查rsync看是否安装，及安装的版本</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="err">$</span> <span class="n">rpm</span> <span class="o">-</span><span class="n">qa</span> <span class="n">rsync</span>
<span class="n">rsync</span><span class="o">-</span><span class="mf">3.0</span><span class="o">.</span><span class="mi">6</span><span class="o">-</span><span class="mf">12.</span><span class="n">el6</span><span class="o">.</span><span class="n">x86_64</span>
</code></pre></div>
<p>rsync有三种模式，分别是本地，ssh远程同步，daemon模式</p>

<ul>
<li><p>Local:  <code>rsync [OPTION...] SRC... [DEST]</code></p></li>
<li><p>Access via remote shell:</p>

<ul>
<li>Pull: <code>rsync [OPTION...] [USER@]HOST:SRC... [DEST]</code></li>
<li>Push: <code>rsync [OPTION...] SRC... [USER@]HOST:DEST</code></li>
</ul></li>
<li><p>Access via rsync daemon:</p>

<ul>
<li>Pull: <code>rsync [OPTION...] [USER@]HOST::SRC... [DEST]</code><br>
  <code>rsync [OPTION...] rsync://[USER@]HOST[:PORT]/SRC... [DEST]</code></li>
<li>Push: <code>rsync [OPTION...] SRC... [USER@]HOST::DEST</code><br>
       <code>rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST</code></li>
</ul></li>
</ul>

<p>都是把SRC的数据同步到DEST. 如果没有DEST，但会把SRC的文件列出来而不copy</p>

<p>rsync 参数说明：</p>

<ul>
<li>--delete;     delete extraneous files from dest dirs 删除目标文件中多余的文件</li>
<li>--exclude=PATTERN ;      exclude files matching PATTERN 排除特定文件 --exclude={a,b}</li>
<li>--exclude-from=FILE;     read exclude patterns from FILE  ,--exclude-from=/tmp/exclude.txt</li>
<li>-z, --compress    ;          compress file data during the transfer</li>
<li>-v, --verbose               increase verbosity</li>
<li>-a, --archive               archive mode; equals -rlptgoD (no -H,-A,-X)</li>
<li>--bwlimit=KBPS          limit I/O bandwidth; KBytes per second </li>
<li>--partial               keep partially transferred files 断点续传</li>
</ul>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#排除单个文件：</span>
<span class="err">$</span> <span class="n">rsync</span> <span class="o">-</span><span class="n">auvrtzopgP</span> <span class="o">--</span><span class="n">progress</span> <span class="o">--</span><span class="n">exclude</span><span class="o">=</span><span class="n">a</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">rsync_backup</span><span class="nd">@172.16.1.41</span><span class="p">::</span><span class="n">backup</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="nb">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>

<span class="c">#排除多个文件：</span>
<span class="err">$</span> <span class="n">rsync</span> <span class="o">-</span><span class="n">avz</span> <span class="o">--</span><span class="n">exclude</span><span class="o">=</span><span class="p">{</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">}</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">rsync_backup</span><span class="nd">@172.16.1.41</span><span class="p">::</span><span class="n">backup</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="nb">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>

<span class="err">$</span> <span class="n">rsync</span> <span class="o">-</span><span class="n">avz</span> <span class="o">--</span><span class="n">exclude</span><span class="o">-</span><span class="n">from</span><span class="o">=</span><span class="n">paichu</span><span class="o">.</span><span class="n">log</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">rsync_backup</span><span class="nd">@172.16.1.41</span><span class="p">::</span><span class="n">backup</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="nb">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span> 
</code></pre></div>
<h3 id="本地备份">本地备份</h3>

<p>本地 模式，相当于copy 或者rm
比如<code>$ rsync -auvrtzopgP /tmp/ /backup/</code> <br/>
此命令就会把tmp目录下的文件全部复制到backup目录下面， 如果加上<code>--delete</code>，此参数的意思是把目标目录与源目录同步，当目标目录里有多于源目录的文件就会删除，也就是源目录是啥样，目标目录就是啥样。如果源目录为空，目标目录也会被清空。我们一般都会在目录后面加<code>/</code>意思是目录下面，如果不加就直接把目录复制过去了，在远程的时候也是一样的。<br/>
保持属性： -avz  相当于 cp -rp<br/>
<br/></p>

<h3 id="通过shell远程传输-remote">通过shell远程传输(remote)</h3>

<p>远程拷贝；相当于ssh带的scp命令，但又优于scp命令的功能。scp每次都是全量拷贝。rsync可以增量拷贝。 当源路径，或目的路径后面包含一个卡号</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="err">$</span> <span class="n">rsync</span> <span class="o">-</span><span class="n">avz</span> <span class="o">-</span><span class="n">e</span> <span class="s">&#39;ssh -p 22&#39;</span> <span class="n">root</span><span class="nd">@172.16.1.41</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span>
<span class="n">The</span> <span class="n">authenticity</span> <span class="n">of</span> <span class="n">host</span> <span class="s">&#39;172.16.1.41 (172.16.1.41)&#39;</span> <span class="n">can</span><span class="s">&#39;t be established.</span>
<span class="n">RSA</span> <span class="n">key</span> <span class="n">fingerprint</span> <span class="ow">is</span> <span class="mi">97</span><span class="p">:</span><span class="n">b9</span><span class="p">:</span><span class="mi">1</span><span class="n">f</span><span class="p">:</span><span class="mi">95</span><span class="p">:</span><span class="mi">8</span><span class="n">b</span><span class="p">:</span><span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="n">ae</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">4</span><span class="n">a</span><span class="p">:</span><span class="n">d4</span><span class="p">:</span><span class="n">b3</span><span class="p">:</span><span class="mi">98</span><span class="p">:</span><span class="n">ae</span><span class="p">:</span><span class="n">c1</span><span class="p">:</span><span class="mf">77.</span>
<span class="n">Are</span> <span class="n">you</span> <span class="n">sure</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="k">continue</span> <span class="n">connecting</span> <span class="p">(</span><span class="n">yes</span><span class="o">/</span><span class="n">no</span><span class="p">)</span><span class="err">?</span> <span class="n">yes</span>
<span class="ne">Warning</span><span class="p">:</span> <span class="n">Permanently</span> <span class="n">added</span> <span class="s">&#39;172.16.1.41&#39;</span> <span class="p">(</span><span class="n">RSA</span><span class="p">)</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">known</span> <span class="n">hosts</span><span class="o">.</span>
<span class="n">root</span><span class="nd">@172.16.1.41</span><span class="s">&#39;s password: </span>
<span class="n">receiving</span> <span class="n">incremental</span> <span class="nb">file</span> <span class="nb">list</span>
<span class="n">created</span> <span class="n">directory</span> <span class="o">/</span><span class="n">temp</span>
<span class="o">./</span>
<span class="n">hosts</span>
<span class="o">.</span><span class="n">ICE</span><span class="o">-</span><span class="n">unix</span><span class="o">/</span>

<span class="n">sent</span> <span class="mi">37</span> <span class="nb">bytes</span>  <span class="n">received</span> <span class="mi">184</span> <span class="nb">bytes</span>  <span class="mf">9.02</span> <span class="nb">bytes</span><span class="o">/</span><span class="n">sec</span>
<span class="n">total</span> <span class="n">size</span> <span class="ow">is</span> <span class="mi">220</span>  <span class="n">speedup</span> <span class="ow">is</span> <span class="mf">1.00</span>
</code></pre></div>
<p><br/>
此命令便是把ip为172.16.1.41的主机里tmp目录下的文件传到本地的/tmp/下。这里 <code>ssh -p 22</code>命令用于指定端口，默认就是22，-e 这个参数可以不写直接 <code>rsync -avz root@172.16.1.41:/tmp/ /tmp/</code>便可以把41的文件复制过来。且这里是交互式，手动备份与推送，十分不方便。</p>

<p>这里有个问题，如果我们用其它用户推或者拉，的时候需要共享文件的所属主与所属组都对该用户对应</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">[</span><span class="n">root</span><span class="vi">@NFS</span> <span class="n">tmp</span><span class="o">]</span><span class="err">$</span> <span class="n">rsync</span> <span class="o">-</span><span class="n">avz</span> <span class="sr">/data/</span> <span class="n">sandow</span><span class="err">@</span><span class="mi">172</span><span class="o">.</span><span class="mi">16</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">41</span><span class="ss">:/</span><span class="n">data</span><span class="o">/</span>
</code></pre></div>
<p>此命令是把本地data目录下的文件推到服务器IP为：41下的data目录下。这里两个data目录都要具有对应主机用户的读取执行写入权限，最好的办法就是把该目录的所属主，所属组改为对应的用户</p>

<h3 id="daemon-模式，">daemon 模式，</h3>

<p>daemon模式需要配置文件，使用<code>rsync --daemon</code>启动进程，使用独立的进程方式传输文件，默认端口是873。</p>

<p>这里需要两台服务器做测试环境，服务器端名为backup, ip为172.16.1.41主要用于存放数据. 客户端(NFS01)IP为172.16.1.31 主要用于向服务器推送（备份）拉回（还原）数据。然后结合crontab实现实时自动备份同步。 </p>

<h4 id="服务端的配置">服务端的配置</h4>

<p>首先我们来配置rsync的主配置文件 rsyncd.conf，默认情况下该文件不存在需要创建，我们也可以使用<code>man rsyncd.conf</code>来查看主配置文件里的参数与说明。</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">[</span><span class="n">root</span><span class="nd">@backup</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">.</span><span class="n">conf</span>
<span class="c">#Rsync server</span>
<span class="c">#created by sandow at 2015-11-05</span>
<span class="c">#rsyncd.conf start#</span>
<span class="n">uid</span> <span class="o">=</span> <span class="n">rsync</span>     <span class="o">//</span><span class="err">相当于</span><span class="n">nfsnobody</span> <span class="err">客户端连过来具备什么样的权限默认是不存在的</span>
<span class="n">gid</span> <span class="o">=</span> <span class="n">rsync</span>     <span class="o">//</span><span class="err">相当于</span><span class="n">nfsnobody</span>
<span class="n">use</span> <span class="n">chroot</span> <span class="o">=</span> <span class="n">no</span>     <span class="o">//</span>   <span class="err">程序出现问题就会开启</span> <span class="err">开启给个空目录就行</span>
<span class="nb">max</span> <span class="n">connections</span> <span class="o">=</span> <span class="mi">200</span>       <span class="o">//</span><span class="err">客户端连接数</span> <span class="err">可以同时</span>
<span class="n">timeout</span> <span class="o">=</span> <span class="mi">300</span>        <span class="o">//</span><span class="err">超时</span> <span class="err">这是服务端</span> <span class="err">客户端连过来最多多久后就断掉</span>
<span class="n">strict</span> <span class="n">modes</span><span class="o">=</span><span class="n">yes</span>
<span class="n">port</span><span class="o">=</span><span class="mi">873</span>
<span class="n">pid</span> <span class="nb">file</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">rstbcd</span><span class="o">.</span><span class="n">pid</span>  <span class="o">//</span><span class="n">PID</span><span class="err">就是进程号唯一标识进程</span><span class="p">,</span><span class="err">进程号放文件里面</span>
<span class="n">lock</span> <span class="nb">file</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">rsync</span><span class="o">.</span><span class="n">lock</span>     <span class="o">//</span><span class="err">锁文件</span>
<span class="n">log</span> <span class="nb">file</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">.</span><span class="n">log</span>      <span class="o">//</span><span class="err">日志文件，出问题在这里看</span>
<span class="n">hosts</span> <span class="n">allow</span> <span class="o">=</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">24</span>     <span class="o">//</span><span class="err">允许</span><span class="n">ip</span>
<span class="n">hosts</span> <span class="n">deny</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">32</span>     <span class="o">//</span><span class="err">拒绝</span>
<span class="n">secrets</span> <span class="nb">file</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>      <span class="o">//</span><span class="err">存放用户和密码文件</span>

<span class="p">[</span><span class="n">backup</span><span class="p">]</span>        <span class="o">//</span><span class="err">模块，调用下面服务</span>
<span class="n">comment</span><span class="o">=</span><span class="n">backup</span> <span class="n">server</span> <span class="n">by</span> <span class="n">liuchunhao</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">05</span>       <span class="o">//</span><span class="err">注释</span>
<span class="n">path</span> <span class="o">=</span> <span class="o">/</span><span class="n">backup</span>      <span class="o">//</span><span class="err">共享目录</span>
<span class="n">read</span> <span class="n">only</span> <span class="o">=</span> <span class="n">false</span>       <span class="o">//</span><span class="err">可读写</span>
<span class="n">ignore</span> <span class="n">errors</span>       <span class="o">//</span><span class="err">忽略错误</span>
<span class="n">auth</span> <span class="n">users</span> <span class="o">=</span> <span class="n">rsync_backup</span>       <span class="o">//</span><span class="err">远程连接的用户，虚拟用户和系统用户没关系</span>
<span class="n">uid</span><span class="o">=</span><span class="n">rsync_backup</span>
<span class="n">gid</span><span class="o">=</span><span class="n">rsync_backup</span>
<span class="nb">list</span> <span class="o">=</span> <span class="n">false</span>        <span class="o">//</span><span class="err">不让远程列表，不让看服务端有什么</span>
<span class="n">secrets</span> <span class="nb">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>
</code></pre></div>
<p>配置好rsyncd.conf后便接下来就可以创建对应用户、目录与密码文件</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">[</span><span class="n">root</span><span class="vi">@backup</span> <span class="o">~]</span><span class="err">$</span> <span class="n">useradd</span> <span class="n">rsync</span> <span class="o">-</span><span class="n">s</span> <span class="sr">/sbin/no</span><span class="n">login</span> <span class="o">-</span><span class="n">M</span>
<span class="o">[</span><span class="n">root</span><span class="vi">@backup</span> <span class="o">~]</span><span class="err">$</span> <span class="nb">id</span> <span class="n">rsync</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">504</span><span class="p">(</span><span class="n">rsync</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">504</span><span class="p">(</span><span class="n">rsync</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">504</span><span class="p">(</span><span class="n">rsync</span><span class="p">)</span>
<span class="o">[</span><span class="n">root</span><span class="vi">@backup</span> <span class="o">~]</span><span class="err">$</span> <span class="n">mkdir</span> <span class="o">-</span><span class="nb">p</span> <span class="sr">/backup</span>
<span class="sr">[root@backup ~]$ chown -R rsync.rsync /</span><span class="n">backup</span><span class="o">/</span>
<span class="o">[</span><span class="n">root</span><span class="vi">@backup</span> <span class="o">~]</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">ld</span> <span class="sr">/backup/</span>              
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">t</span><span class="o">.</span> <span class="mi">3</span> <span class="n">rsync</span> <span class="n">rsync</span> <span class="mi">4096</span> <span class="no">Nov</span> <span class="mi">12</span> <span class="mo">06</span><span class="p">:</span><span class="mi">53</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span>
</code></pre></div>
<p>创建密码文件，并且修改属性为600</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">[</span><span class="n">root</span><span class="vi">@backup</span> <span class="o">~]</span><span class="err">$</span> <span class="n">echo</span> <span class="s2">&quot;rsync_backup:oldboy&quot;</span> <span class="o">&gt;</span><span class="sr">/etc/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>
<span class="o">[</span><span class="n">root</span><span class="vi">@backup</span> <span class="o">~]</span><span class="err">$</span> <span class="n">cat</span> <span class="sr">/etc/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>
<span class="ss">rsync_backup</span><span class="p">:</span><span class="n">oldboy</span>
<span class="o">[</span><span class="n">root</span><span class="vi">@backup</span> <span class="o">~]</span><span class="err">$</span> <span class="n">chmod</span> <span class="mi">600</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>
<span class="o">[</span><span class="n">sandow</span><span class="vi">@backup</span> <span class="o">~]</span><span class="err">$</span> <span class="n">ll</span> <span class="sr">/etc/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>       
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">20</span> <span class="mi">11</span><span class="err">月</span>  <span class="mi">6</span> <span class="mi">16</span><span class="p">:</span><span class="mi">12</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>
</code></pre></div>
<p>修改/etc/xinetd.d/rsync 文件，把disable 改为no,这应该是最新版本的linux才会有此文件。所以没有的可以不配置</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># default: off</span>
<span class="c1"># description: The rsync server is a good addition to an ftp server, as it \</span>
<span class="c1">#   allows crc checksumming etc.</span>
<span class="n">service</span> <span class="n">rsync</span>
<span class="p">{</span>
    <span class="n">disable</span> <span class="o">=</span> <span class="n">no</span>
    <span class="n">flags</span>       <span class="o">=</span> <span class="no">IPv6</span>
    <span class="n">socket_type</span>     <span class="o">=</span> <span class="n">stream</span>
    <span class="n">wait</span>            <span class="o">=</span> <span class="n">no</span>
    <span class="n">user</span>            <span class="o">=</span> <span class="n">root</span>
    <span class="n">server</span>          <span class="o">=</span> <span class="sr">/usr/</span><span class="n">bin</span><span class="o">/</span><span class="n">rsync</span>
    <span class="n">server_args</span>     <span class="o">=</span> <span class="o">--</span><span class="n">daemon</span>
    <span class="n">log_on_failure</span>  <span class="o">+=</span> <span class="no">USERID</span>
<span class="p">}</span>
</code></pre></div>
<p>配置好后便可以启动rsync daemon守护进程了</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">[</span><span class="n">sandow</span><span class="vi">@backup</span> <span class="n">tmp</span><span class="o">]</span><span class="err">$</span> <span class="n">rsync</span> <span class="o">--</span><span class="n">daemon</span>

<span class="o">[</span><span class="n">sandow</span><span class="vi">@backup</span> <span class="n">tmp</span><span class="o">]</span><span class="err">$</span> <span class="n">ps</span> <span class="o">-</span><span class="n">ef</span><span class="o">|</span><span class="n">grep</span> <span class="n">rsync</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">grep</span>
<span class="n">root</span>       <span class="mi">2370</span>      <span class="mi">1</span>  <span class="mi">0</span> <span class="mo">01</span><span class="p">:</span><span class="mi">57</span> <span class="o">?</span>        <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="n">rsync</span> <span class="o">--</span><span class="n">daemon</span>

<span class="o">[</span><span class="n">sandow</span><span class="vi">@backup</span> <span class="n">tmp</span><span class="o">]</span><span class="err">$</span> <span class="n">netstat</span> <span class="o">-</span><span class="n">lntup</span><span class="o">|</span><span class="n">grep</span> <span class="n">rsync</span>
<span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span><span class="mi">873</span>                 <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="ss">:*</span>                   <span class="no">LISTEN</span>      <span class="mi">2370</span><span class="o">/</span><span class="n">rsync</span>          
<span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="o">::</span><span class="p">:</span><span class="mi">873</span>                      <span class="o">::</span><span class="ss">:*</span>                        <span class="no">LISTEN</span>      <span class="mi">2370</span><span class="o">/</span><span class="n">rsync</span>   
</code></pre></div>
<p>然后让rsync开机自动启动：</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">echo</span> <span class="s2">&quot;/usr/bin/rsync --daemon&quot;</span> <span class="o">&gt;&gt;</span><span class="sr">/etc/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span>
</code></pre></div>
<p>这里需要注意的是要让端口873通过防火墙</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">$</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="no">INPUT</span> <span class="o">-</span><span class="nb">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="no">NEW</span>  <span class="o">-</span><span class="n">m</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">873</span> <span class="o">-</span><span class="n">j</span> <span class="no">ACCEPT</span>
<span class="err">$</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">L</span>  <span class="err">查看一下防火墙是不是打开了</span> <span class="mi">873</span><span class="err">端口</span>
</code></pre></div>
<h4 id="客户端的配置">客户端的配置</h4>

<p>客户端的配置很简单，仅需要增加一个密码文件并把权限改为600</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">[</span><span class="n">root</span><span class="vi">@NFS</span> <span class="n">tmp</span><span class="o">]</span><span class="err">$</span> <span class="n">echo</span> <span class="s2">&quot;oldboy&quot;</span> <span class="o">&gt;</span><span class="sr">/etc/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>
<span class="o">[</span><span class="n">root</span><span class="vi">@NFS</span> <span class="n">tmp</span><span class="o">]</span><span class="err">$</span> <span class="n">chmod</span> <span class="mi">600</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span> 
<span class="o">[</span><span class="n">root</span><span class="vi">@NFS</span> <span class="n">tmp</span><span class="o">]</span><span class="err">$</span> <span class="n">ll</span> <span class="sr">/etc/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span> 
<span class="o">-</span><span class="n">rw</span><span class="o">-------.</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">7</span> <span class="no">Nov</span> <span class="mi">12</span> <span class="mo">02</span><span class="p">:</span><span class="mo">03</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>
<span class="o">[</span><span class="n">root</span><span class="vi">@NFS</span> <span class="n">tmp</span><span class="o">]</span><span class="err">$</span> <span class="n">cat</span> <span class="sr">/etc/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span> 
<span class="n">oldboy</span>
</code></pre></div>
<h4 id="备份数据以及自动备份">备份数据以及自动备份</h4>

<p>向服务器推送数据：</p>

<p><code>rsync -auvrtzopgP --progress  /backup/ rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password</code></p>

<p>或者</p>

<p><code>rsync -auvrtzopgP --progress  /backup/ rsync://rsync_backup@172.16.1.41/backup --password-file=/etc/rsync.password</code></p>

<p>从服务器拉回数据</p>

<p><code>rsync -avz   rsync_backup@172.16.1.41::backup /backup/ --password-file=/etc/rsync.password</code></p>

<p>或者</p>

<p><code>rsync -avz   rsync://rsync_backup@172.16.1.41/backup  /backup/ --password-file=/etc/rsync.password</code></p>

<h3 id="小结">小结</h3>

<p>配置步骤回顾</p>

<blockquote>
<p>查看rsync 安装包&gt;&gt;  添加rsync用户 &gt;&gt;  生成配置文件 &gt;&gt;   配置账户，密码文件 &gt;&gt;  密码文件配置权限 600  &gt;&gt;  创建共享的目录并授权rsync &gt;&gt;启动rsync  <code>rsync --daemon</code> &gt;&gt; 开机启动
排错小结：查看推送或者拉取报错信息， 查看日志 <code>tail /var/log/rsyncd.log</code></p>
</blockquote>

<p>重启rsync就必须杀掉进程</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">[</span><span class="n">root</span><span class="vi">@backup</span> <span class="n">backup</span><span class="o">]</span><span class="err">$</span> <span class="n">kill</span> <span class="sb">`cat /var/run/rsyncd.pid`</span>
<span class="o">[</span><span class="n">root</span><span class="vi">@backup</span> <span class="n">backup</span><span class="o">]</span><span class="err">$</span> <span class="n">lsof</span> <span class="o">-</span><span class="n">i</span> <span class="p">:</span><span class="mi">873</span>
<span class="o">[</span><span class="n">root</span><span class="vi">@backup</span> <span class="n">backup</span><span class="o">]</span><span class="err">$</span> <span class="n">pkill</span> <span class="n">rsync</span>
<span class="o">[</span><span class="n">root</span><span class="vi">@backup</span> <span class="n">backup</span><span class="o">]</span><span class="err">$</span> <span class="n">killall</span> <span class="n">rsync</span>
</code></pre></div>
<p>rsync 优点
1. 增量备份， 支持socket 集中备份，（支持推拉，都是以客户端参照物）
2. 远程shell 通道模式还可以加密(ssh) 传输 。 socket 需要加密传输，可以利用vpn 服务或ipsec服务</p>

<p>rsync 缺点
1.  大量小文件时候同步的时候，比对时间长，有的时候，rsync进程可能会停止
2.  同步大文件，10G 这样的大文件有时也会问题，中断。 未完整同步前，是隐藏文件</p>

<p>实战作业：
5.1.4.2 备份全网服务器数据生产架构方案案例模型
企业案例：rsync上机实战考试题： 
某公司里有一台Web服务器，里面的数据很重要，但是如果硬盘坏了，数据就会丢失，现在领导要求你把数据在其他机器上做一个周期性定时备份。要求如下：
每天晚上00点整在Web服务器A上打包备份网站程序目录并通过rsync命令推送到服务器B上备份保留（备份思路可以是先在本地按日期打包，然后再推到备份服务器上）。
具体要求如下：
1)Web服务器A和备份服务器B的备份目录必须都为/backup。
2)Web服务器站点目录假定为(/var/www/html)。
3)Web服务器本地仅保留7天内的备份。
4)备份服务器上检查备份结果是否正常，并将每天的备份结果发给管理员信箱（选做）。
5)备份服务器上每周六的数据都保留，其他备份仅保留180天备份（选做）。</p>

<p>拔锚必备思想：
部署流程步骤熟练
rsync原理理解</p>

<h2 id="crontab-rsync-定时推送">crontab + rsync 定时推送</h2>

<p>定时任务一般都新建一个目录专门用来存放定时任务的sh.我一般呢会存放在<strong>/server/scripts/</strong>目录下面。 新建一个sh 命名为rsync.dailyBackup.sh. 增加好下内容</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">$</span> <span class="n">cat</span> <span class="n">rsync</span><span class="o">.</span><span class="n">dailyBackup</span><span class="o">.</span><span class="n">sh</span>
<span class="c1">#! /bin/sh</span>
<span class="c1"># backup /backup  to 172.16.1.41:/backup</span>
<span class="n">path</span><span class="o">=</span><span class="sr">/backup</span>
<span class="sr">hostn=$(hostname)</span>
<span class="sr">dir=${hostn}-172.16.1.31</span>
<span class="sr">ldate=$(date +%F)</span>
<span class="sr">mkdir  ${path}/</span><span class="err">$</span><span class="p">{</span><span class="n">dir</span><span class="p">}</span> <span class="o">&amp;&amp;</span><span class="p">\</span>
<span class="sr">/bin/</span><span class="n">cp</span> <span class="sr">/etc/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span> <span class="err">$</span><span class="p">{</span><span class="n">path</span><span class="p">}</span><span class="o">/</span><span class="err">$</span><span class="p">{</span><span class="n">dir</span><span class="p">}</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">local_</span><span class="err">$</span><span class="p">{</span><span class="n">ldate</span><span class="p">}</span> <span class="o">&amp;&amp;</span><span class="p">\</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">az</span> <span class="err">$</span><span class="p">{</span><span class="n">path</span><span class="p">}</span><span class="o">/</span> <span class="n">rsync_backup</span><span class="err">@</span><span class="mi">172</span><span class="o">.</span><span class="mi">16</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">41</span><span class="o">::</span><span class="n">backup</span><span class="o">/</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=</span><span class="sr">/etc/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>
</code></pre></div>
<p>首先测试是否成功执行任务，并推送到rsync服务器。然后便写入crontab </p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">$</span> <span class="n">crontab</span> <span class="o">-</span><span class="n">l</span>
<span class="c1">#######time sync by lzy at 2015-11-02</span>
<span class="o">*/</span><span class="mi">5</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="sr">/usr/s</span><span class="n">bin</span><span class="o">/</span><span class="n">ntpdate</span> <span class="n">time</span><span class="o">.</span><span class="n">nist</span><span class="o">.</span><span class="n">gov</span> <span class="o">&gt;</span><span class="sr">/dev/nu</span><span class="n">ll</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="c1">####rsync by lzy at 2015-11-07</span>
<span class="mo">00</span> <span class="mo">01</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="sr">/bin/s</span><span class="n">h</span> <span class="sr">/server/s</span><span class="n">cripts</span><span class="o">/</span><span class="n">rsync</span><span class="o">.</span><span class="n">sh</span> <span class="o">&gt;</span><span class="sr">/dev/nu</span><span class="n">ll</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
</code></pre></div>
<h2 id="实时同步">实时同步</h2>

<p>inotify+rsync 
inotify 是一种强大的细粒度的，异步的文件系统事件监控机制， linux内核从2.6.13起，加入了inotify支持。其本身没有推送的功能，只 有监控文件系统的任务. 我们可以用inotify + rsync 做到实时复制，但是
sersync 国人周洋编辑的
inotify + rsync 实时复制  osersync
每秒只能同步200张100K的图片  可以用drbd （备节点不可用）  双协</p>

<p>查看系统是否支持inotify，如果没有下列文件便表示不支持</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">$</span> <span class="n">ll</span> <span class="sr">/proc/s</span><span class="n">ys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">inotify</span><span class="o">/</span>
<span class="n">total</span> <span class="mi">0</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">0</span> <span class="no">Nov</span>  <span class="mi">9</span> <span class="mi">17</span><span class="p">:</span><span class="mi">39</span> <span class="n">max_queued_events</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">0</span> <span class="no">Nov</span>  <span class="mi">9</span> <span class="mi">17</span><span class="p">:</span><span class="mi">39</span> <span class="n">max_user_instances</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">0</span> <span class="no">Nov</span>  <span class="mi">9</span> <span class="mi">17</span><span class="p">:</span><span class="mi">39</span> <span class="n">max_user_watches</span>
</code></pre></div>
<ul>
<li>max_queued_events,表示调用inotify_init时分配给inotify instance中可排队的event的数目的最大值，超出这值的事件被丢弃，触发IN_Q_OVERFLOW事件</li>
<li>max_user_instances 每一个user ID可创建的inotify instatnces的数量上限</li>
<li>max_user_watches表示每个inotify instatnces可监控的最大目录数量。</li>
</ul>

<p>安装inotify-tools
方法一</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">$</span> <span class="n">rpm</span> <span class="o">-</span><span class="n">ivh</span> <span class="sr">/apps/</span><span class="n">crm</span><span class="o">/</span><span class="n">soft_src</span><span class="o">/</span><span class="n">inotify</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="mi">14</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="n">el6</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span> 
<span class="ss">warning</span><span class="p">:</span> <span class="sr">/apps/</span><span class="n">crm</span><span class="o">/</span><span class="n">soft_src</span><span class="o">/</span><span class="n">inotify</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="mi">14</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="n">el6</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span><span class="p">:</span> <span class="no">Header</span> <span class="no">V3</span> <span class="no">DSA</span><span class="o">/</span><span class="no">SHA1</span> <span class="no">Signature</span><span class="p">,</span> <span class="n">key</span> <span class="no">ID</span> <span class="mi">4026433</span><span class="ss">f</span><span class="p">:</span> <span class="no">NOKEY</span>
<span class="no">Preparing</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>                <span class="c1">########################################### [100%]</span>
   <span class="mi">1</span><span class="ss">:inotify</span><span class="o">-</span><span class="n">tools</span>          <span class="c1">########################################### [100%]</span>
<span class="err">$</span> <span class="n">rpm</span> <span class="o">-</span><span class="n">qa</span><span class="o">|</span><span class="n">grep</span> <span class="n">inotify</span>
<span class="n">inotify</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="mi">14</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="n">el5</span><span class="o">.</span><span class="n">x86_64</span>
</code></pre></div>
<p>方法二</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">wget</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">downloads</span><span class="o">/</span><span class="n">rvoicilas</span><span class="o">/</span><span class="n">inotify</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">inotify</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="mi">14</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">tar</span> <span class="n">zxvf</span> <span class="n">inotify</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="mi">14</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">cd</span> <span class="n">inotify</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="mi">14</span>
<span class="o">.</span><span class="n">/configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=</span><span class="sr">/usr/</span><span class="n">local</span><span class="o">/</span><span class="n">inotify</span>
<span class="n">make</span>
<span class="n">make</span> <span class="n">install</span>
</code></pre></div>
<h3 id="inotifywait-介绍">inotifywait 介绍</h3>

<p>如果文件或者目录变更，那么就会调用inotify命令。是一个非常高效的工具。
其语法格式是</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">inotifywait</span> <span class="o">[-</span><span class="n">hcmrq</span><span class="o">]</span> <span class="o">[-</span><span class="n">e</span> <span class="o">&lt;</span><span class="n">event</span><span class="o">&gt;</span> <span class="o">]</span> <span class="o">[-</span><span class="n">t</span> <span class="o">&lt;</span><span class="n">seconds</span><span class="o">&gt;</span> <span class="o">]</span> <span class="o">[--</span><span class="nb">format</span> <span class="o">&lt;</span><span class="n">fmt</span><span class="o">&gt;</span> <span class="o">]</span> <span class="o">[--</span><span class="n">timefmt</span> <span class="o">&lt;</span><span class="n">fmt</span><span class="o">&gt;</span> <span class="o">]</span> <span class="o">&lt;</span><span class="n">file</span><span class="o">&gt;</span> <span class="o">[</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="o">]</span>
</code></pre></div>
<p>参数：</p>

<ul>
<li>-m  监听</li>
<li> -r, --recursive 递归监控</li>
<li>  -q, --quiet，不输出信息</li>
<li> --exclude <pattern\></li>
<li> -e <event\>, --event <event\>

<ul>
<li>delete ,create,close_write,modify </li>
</ul></li>
<li>--timefmt <fmt> 设置一个时间样式</li>
</ul>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">inotifywait</span> <span class="o">-</span><span class="n">mrq</span> <span class="o">--</span><span class="n">timefmt</span> <span class="s1">&#39;%d/%m/%y %H:%M&#39;</span> <span class="o">--</span><span class="nb">format</span> <span class="s1">&#39;%T %w %f&#39;</span> <span class="o">-</span><span class="n">e</span> <span class="n">create</span> <span class="sr">/backup  </span>
<span class="sr">inotifywait -mrq --timefmt &#39;%d/</span><span class="o">%</span><span class="n">m</span><span class="o">/%</span><span class="n">y</span> <span class="o">%</span><span class="ss">H</span><span class="p">:</span><span class="o">%</span><span class="n">M</span><span class="s1">&#39; --format &#39;</span><span class="o">%</span><span class="n">T</span> <span class="sx">%w %f&#39; </span><span class="o">-</span><span class="n">e</span> <span class="n">create</span><span class="p">,</span><span class="n">delete</span><span class="p">,</span><span class="n">close_write</span> <span class="sr">/backup</span>
</code></pre></div>
<p>执行第二个命令后的结果格式结果是</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">47</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">a</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">47</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">a</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">47</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">a</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">47</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">a</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">47</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">swp</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">47</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">swx</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">47</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">swx</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">47</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">swx</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">47</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">swp</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">47</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">swp</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">47</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">swp</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">48</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="nb">test</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">48</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="nb">test</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">48</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">swp</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">48</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">swp</span>
</code></pre></div>
<p>刚才注意到 创建一个文件产生的临时文件也都会被记录下来。而且还有重复。为了同步时减少带宽与CPU消耗，就需要使用排除，来排除指定的文件。排除一般有两种方法：1，使用rsync排除; 2,使用inotify排除，同时加入rsync排除,我们一般使用第二种
inotifywati排队监控目录有 --exclude <pattern\> --formfile <file\> 前面可以用正则，后者只能是具体的目录或文件</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">vi</span> <span class="n">inotify_exclude</span><span class="o">.</span><span class="n">lst</span>
<span class="sr">/tmp/s</span><span class="n">rc</span><span class="o">/</span><span class="n">pdf</span>
<span class="err">@</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="mi">2014</span>
</code></pre></div>
<p>--formfile 的file只能使用绝对路径，@表示排除。
用正则排除 </p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">--</span><span class="n">exclude</span> <span class="s1">&#39;(.*/*\.log|.*/*\.swp)$|^/tmp/src/mail/(2014|201.*/cache.*)&#39;</span>
</code></pre></div>
<p>正则很明子了吧。 排除所有目录下以<strong>.log</strong>, <strong>.swp</strong> 结尾的文件，和所有在/tmp/src/mail下面2014这个目录和201*目录下的cache开头的文件或目录
在rsync里排除，这里指定file排除时用相对路径。</p>

<p>写一个角本<strong>inotifywait.sh</strong>放到backup目录下面,执行便可以实时同步，以下是几个版本
粗糙版，每次都会让rsync比对所有文件然后再同步</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#! /bin/bash</span>
<span class="sr">/usr/</span><span class="n">bin</span><span class="o">/</span><span class="n">inotifywait</span> <span class="o">-</span><span class="n">mrq</span>  <span class="o">--</span><span class="nb">format</span> <span class="s1">&#39;%w%f&#39;</span> <span class="o">-</span><span class="n">e</span> <span class="n">create</span><span class="p">,</span><span class="n">close_write</span><span class="p">,</span><span class="n">delete</span> <span class="sr">/backup | \</span>
<span class="sr">while read file</span>
<span class="sr">do</span>
<span class="sr">    cd /</span><span class="n">backup</span> <span class="o">&amp;&amp;</span> <span class="p">\</span>
    <span class="n">rsync</span> <span class="o">-</span><span class="n">az</span> <span class="o">.</span><span class="n">/</span> <span class="o">--</span><span class="n">delete</span> <span class="n">rsync_backup</span><span class="err">@</span><span class="mi">172</span><span class="o">.</span><span class="mi">16</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">41</span><span class="o">::</span><span class="n">backup</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=</span><span class="sr">/etc/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>
<span class="n">done</span>
</code></pre></div>
<p>精准版</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#! /bin/sh</span>
<span class="no">FullPath</span><span class="o">=</span><span class="s2">&quot;/usr/bin/inotifywait&quot;</span>

<span class="err">$</span><span class="p">{</span><span class="no">FullPath</span><span class="p">}</span> <span class="o">-</span><span class="n">mrq</span> <span class="o">--</span><span class="nb">format</span> <span class="s1">&#39;%w%f&#39;</span> <span class="o">-</span><span class="n">e</span> <span class="n">create</span><span class="p">,</span><span class="n">close_write</span><span class="p">,</span><span class="n">delete</span> <span class="sr">/backup | \</span>
<span class="sr">    while read Line</span>
<span class="sr">    do</span>
<span class="sr">    [ ! -e  &quot;$line&quot; ]  &amp;&amp;\</span>
<span class="sr">  rsync -az --delete ./</span> <span class="n">rsync_backup</span><span class="err">@</span><span class="mi">172</span><span class="o">.</span><span class="mi">16</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">41</span><span class="o">::</span><span class="n">backup</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=</span><span class="sr">/etc/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span> <span class="o">&amp;&amp;</span> <span class="p">\</span>
    <span class="n">continue</span>
  <span class="n">rsync</span> <span class="o">-</span><span class="n">az</span> <span class="o">--</span><span class="n">delete</span> <span class="err">$</span><span class="p">{</span><span class="no">Line</span><span class="p">}</span> <span class="n">rsync_backup</span><span class="err">@</span><span class="mi">172</span><span class="o">.</span><span class="mi">16</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">41</span><span class="o">::</span><span class="n">backup</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=</span><span class="sr">/etc/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>
    <span class="n">done</span>
</code></pre></div>
<p>上面的是不是很简单，那么再来一个更全面的客户端配置文件</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#rsync auto sync script with inotify</span>
<span class="c1">#2015-11-09 sandow</span>
<span class="c1">#variables</span>
<span class="no">Current_date</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">date</span> <span class="o">+%</span><span class="n">Y</span><span class="o">%</span><span class="n">m</span><span class="o">%</span><span class="n">d_</span><span class="o">%</span><span class="n">H</span><span class="o">%</span><span class="n">M</span><span class="o">%</span><span class="n">S</span><span class="p">)</span>
<span class="n">source_path</span><span class="o">=</span><span class="sr">/backup/</span>
<span class="n">log_file</span><span class="o">=</span><span class="sr">/var/</span><span class="n">log</span><span class="o">/</span><span class="n">rsync_client</span><span class="o">.</span><span class="n">log</span>
<span class="c1">#rsync</span>
<span class="n">rsync_server</span><span class="o">=</span><span class="mi">172</span><span class="o">.</span><span class="mi">16</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">41</span>
<span class="n">rsync_user</span><span class="o">=</span><span class="n">rsync_backup</span>
<span class="n">rsync_pwd</span><span class="o">=</span><span class="sr">/etc/</span><span class="n">rsync</span><span class="o">.</span><span class="n">password</span>
<span class="n">rsync_module</span><span class="o">=</span><span class="n">backup</span>
<span class="no">INOTIFY_EXCLUDE</span><span class="o">=</span><span class="s2">&quot;(.*/*\.log|.*/*\.swp)$|^/tmp/src/mail/(2014|20.*/.*che.*)&quot;</span>
<span class="no">RSYNC_EXCLUDE</span><span class="o">=</span><span class="sr">/etc/</span><span class="n">rsyncd</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rsync_exclude</span><span class="o">.</span><span class="n">lst</span>
<span class="c1">#rsync client pwd check</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="o">-</span><span class="n">e</span> <span class="err">$</span><span class="p">{</span><span class="n">rsync_pwd</span><span class="p">}</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    <span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;rsync client passwod file ${rsync_pwd} does not exist!&quot;</span>
    <span class="nb">exit</span> <span class="mi">0</span>
<span class="n">fi</span>
<span class="c1">#inotify_function</span>
<span class="n">inotify_fun</span><span class="p">(){</span>
    <span class="sr">/usr/</span><span class="n">bin</span><span class="o">/</span><span class="n">inotifywait</span> <span class="o">-</span><span class="n">mrq</span> <span class="o">--</span><span class="n">timefmt</span> <span class="s1">&#39;%Y/%m/%d-%H:%M:%S&#39;</span> <span class="o">--</span><span class="nb">format</span> <span class="s1">&#39;%T %w %f&#39;</span> <span class="p">\</span>
          <span class="o">--</span><span class="n">exclude</span> <span class="err">$</span><span class="p">{</span><span class="no">INOTIFY_EXCLUDE</span><span class="p">}</span>  <span class="o">-</span><span class="n">e</span> <span class="n">modify</span><span class="p">,</span><span class="n">delete</span><span class="p">,</span><span class="n">create</span><span class="p">,</span><span class="n">move</span><span class="p">,</span><span class="n">attrib</span> <span class="err">$</span><span class="p">{</span><span class="n">source_path</span><span class="p">}</span> <span class="o">|</span> <span class="p">\</span>
      <span class="k">while</span> <span class="n">read</span> <span class="n">file</span>
      <span class="k">do</span>
          <span class="sr">/usr/</span><span class="n">bin</span><span class="o">/</span><span class="n">rsync</span> <span class="o">-</span><span class="n">auvrtzopgP</span> <span class="o">--</span><span class="n">exclude</span><span class="o">-</span><span class="n">from</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="no">RSYNC_EXCLUDE</span><span class="p">}</span> <span class="o">--</span><span class="n">progress</span> <span class="o">--</span><span class="n">bwlimit</span><span class="o">=</span><span class="mi">200</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">rsync_pwd</span><span class="p">}</span> <span class="err">$</span><span class="p">{</span><span class="n">source_path</span><span class="p">}</span> <span class="err">$</span><span class="p">{</span><span class="n">rsync_user</span><span class="p">}</span><span class="err">@$</span><span class="p">{</span><span class="n">rsync_server</span><span class="p">}</span><span class="o">::</span><span class="err">$</span><span class="p">{</span><span class="n">rsync_module</span><span class="p">}</span> 
      <span class="n">done</span>
<span class="p">}</span>
<span class="c1">#inotify log</span>
<span class="n">inotify_fun</span> <span class="o">&gt;&gt;</span> <span class="err">$</span><span class="p">{</span><span class="n">log_file</span><span class="p">}</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">&amp;</span>
</code></pre></div>
<p>来点链接，深入研究的话可以上去查看 <br/></p>

<blockquote>
<p><a href="https://rsync.samba.org/how-rsync-works.html">How Rsync Works A Practical Overview</a> <br/>
<a href="https://www.ibm.com/developerworks/cn/linux/l-inotify/">用 inotify 监控 Linux 文件系统事件</a> <br/>
<a href="http://www.infoq.com/cn/articles/inotify-linux-file-system-event-monitoring">inotify: 高效、实时的Linux文件系统事件监控框架</a> <br/>
<a href="http://coolshell.cn/articles/7425.html">rsync 的核心算法</a></p>
</blockquote>

<h2 id="sersync">sersync</h2>

<p>听同事说 sersync 这么个工具可以提高同步的性能，也解决了同步大文件时出现异常的问题，所以就尝试了一下。sersync是国内的一个开发者开源出来的，使用c++编写，采用多线程的方式进行同步，失败后还有重传机制，对临时文件过滤，自带crontab定时同步功能。网上看到有人说性能还不错，但是我觉得：</p>

<p>国产开源，文档不是很全，在2011年之后就没更新了。采用xml配置文件的方式，可读性比较好，但是有些原生的有些功能没有实现就没法使用了。</p>

<p>无法实现多目录同步，只能通过多个配置文件启动多个进程，文件排除功能太弱。</p>

<p>虽然提供插件的功能，但很鸡肋，因为软件本身没有持续更新，也没有看到贡献有其它插件出现（可能是我知识面不够，还用不到里面的refreshCDN plugin）。虽然不懂c++，但大致看了下源码 FileSynchronize，拼接rsync命令大概在273行左右，最后一个函数就是排除选项，简单一点可以将--exclude=改成--eclude-from来灵活控制。有机会再改吧。</p>

<p>另外，在作者的文章 Sersync服务器同步程序 项目简介与设计框架 评论中，说能解决上面 rsync + inotify中所描述的问题。阅读了下源码，这个应该是没有解决，因为在拼接rsync命令时，后面的目的地址始终是针对module的，只要执行rsync命令，就会对整个目录进行遍历，发送要比对的文件列表，然后再发送变化的文件。sersync只是减少了监听的事件，减少了rsync的次数——这已经是很大的改进，但每次rsync没办法改变。（如有其它看法可与我讨论）</p>

<p>其实我们也不能要求每一个软件功能都十分健全，关键是看能否满足我们当下的特定的需求。所谓好的架构不是设计出来的，而是进化来的。目前使用sersync2没什么问题，而且看了它的设计思路应该是比较科学的，特别是过滤队列的设计。双向同步看起来也是可以实现。</p>

<h2 id="rsync常见错误与问题">rsync常见错误与问题</h2>

<p>Q：如何通过ssh进行rsync，而且无须输入密码？<br>
- 可以通过以下几个步骤        </p>

<ol>
<li>通过ssh-keygen在server A上建立SSH keys，不要指定密码，你会在~/.ssh下看到identity和identity.pub文件 </li>
<li>在server B上的home目录建立子目录.ssh</li>
<li>将A的identity.pub拷贝到server B上</li>
<li>将identity.pub加到~[user b]/.ssh/authorized_keys</li>
<li>于是server A上的A用户，可通过下面命令以用户B ssh到server B上了。e.g. ssh -l userB serverB。这样就使server A上的用户A就可以ssh以用户B的身份无需密码登陆到server B上了。</li>
</ol>

<p>Q：如何通过在不危害安全的情况下通过防火墙使用rsync?</p>

<ul>
<li>解答如下： 
这通常有两种情况，一种是服务器在防火墙内，一种是服务器在防火墙外。无论哪种情况，通常还是使用ssh，这时最好新建一个备份用户，并且配置sshd 仅允许这个用户通过RSA认证方式进入。如果服务器在防火墙内，则最好限定客户端的IP地址，拒绝其它所有连接。如果客户机在防火墙内，则可以简单允许防 火墙打开TCP端口22的ssh外发连接就ok了。</li>
</ul>

<p>Q：我能将更改过或者删除的文件也备份上来吗？</p>

<ul>
<li>当然可 以。你可以使用如：rsync -other -options -backupdir = ./backup-2000-2-13  ...这样的命令来实现。这样如果源文件:/path/to/some/file.c改变了，那么旧的文件就会被移到./backup- 2000-2-13/path/to/some/file.c，这里这个目录需要自己手工建立起来</li>
</ul>

<p>Q：我需要在防火墙上开放哪些端口以适应rsync？</p>

<ul>
<li>视情况而定。rsync可以直接通过873端口的tcp连接传文件，也可以通过22端口的ssh来进行文件传递，但你也可以通过下列命令改变它的端口：</li>
</ul>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="err">$</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span>  <span class="o">-</span><span class="n">m</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">873</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>  
</code></pre></div>
<p><code>rsync --port 8730 otherhost::</code>或者<code>rsync -e &#39;ssh -p 2002&#39; otherhost:</code></p>

<p>Q：我如何通过rsync只复制目录结构，忽略掉文件呢？   </p>

<ul>
<li><code>rsync -av --include &#39;*/&#39; --exclude &#39;*&#39; source-dir dest-dir</code></li>
</ul>

<p>Q：为什么我总会出现&quot;Read-only file system&quot;的错误呢？<br>
 - 看看是否忘了设&quot;read only = no&quot;了</p>

<p>Q：为什么我会出现&#39;@ERROR: invalid gid&#39;的错误呢？</p>

<ul>
<li>rsync使用时默认是用uid=nobody;gid=nobody来运行的，如果你的系统不存在nobody组的话，就会出现这样的错误，可以试试gid = ogroup或者其它</li>
</ul>

<p>Q：绑定端口873失败是怎么回事？</p>

<ul>
<li>如果你不是以root权限运行这一守护进程的话，因为1024端口以下是特权端口，会出现这样的错误。你可以用--port参数来改变。</li>
</ul>

<p>Q：为什么我认证失败？ 
 - 从你的命令行看来：你用的是</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">bash</span><span class="err">$</span> <span class="n">rsync</span> <span class="o">-</span><span class="n">a</span> <span class="mf">144.16</span><span class="o">.</span><span class="mf">251.213</span><span class="p">::</span><span class="n">test</span> <span class="n">test</span>
<span class="n">Password</span><span class="p">:</span>
<span class="nd">@ERROR</span><span class="p">:</span> <span class="n">auth</span> <span class="n">failed</span> <span class="n">on</span> <span class="n">module</span> <span class="n">test</span> 
</code></pre></div>
<p>应该是没有以你的用户名登陆导致的问题，试试rsync -a <a href="mailto:max@144.16.251.213">max@144.16.251.213</a>::test test</p>

<p>Q: 出现以下这个讯息, 是怎么一回事?    </p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@ERROR</span><span class="p">:</span> <span class="n">auth</span> <span class="n">failed</span> <span class="n">on</span> <span class="n">module</span> <span class="n">xxxxx</span>
<span class="n">rsync</span><span class="p">:</span> <span class="n">connection</span> <span class="n">unexpectedly</span> <span class="n">closed</span> <span class="p">(</span><span class="mi">90</span> <span class="nb">bytes</span> <span class="n">read</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span>
<span class="n">rsync</span> <span class="n">error</span><span class="p">:</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">rsync</span> <span class="n">protocol</span> <span class="n">data</span> <span class="n">stream</span> <span class="p">(</span><span class="n">code</span> <span class="mi">12</span><span class="p">)</span> <span class="n">at</span> <span class="n">io</span><span class="o">.</span><span class="n">c</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>这是因为密码设错了, 无法登入成功, 请再检查一下 rsyncd.secrets 中的密码设定, 二端是否一致?</li>
</ul>

<p>Q: 出现以下这个讯息, 是怎么一回事?    </p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">password</span> <span class="nb">file</span> <span class="n">must</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">other</span><span class="o">-</span><span class="n">accessible</span> 
<span class="n">continuing</span> <span class="n">without</span> <span class="n">password</span> <span class="nb">file</span> 
<span class="n">Password</span><span class="p">:</span>
</code></pre></div>
<ul>
<li>这表示 rsyncd.secrets 的档案权限属性不对, 应设为 600。请下 chmod 600 rsyncd.secrets</li>
</ul>

<p>Q: 出现以下这个讯息, 是怎么一回事?</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@ERROR</span><span class="p">:</span> <span class="n">chroot</span> <span class="n">failed</span>
<span class="n">rsync</span><span class="p">:</span> <span class="n">connection</span> <span class="n">unexpectedly</span> <span class="n">closed</span> <span class="p">(</span><span class="mi">75</span> <span class="nb">bytes</span> <span class="n">read</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span>
<span class="n">rsync</span> <span class="n">error</span><span class="p">:</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">rsync</span> <span class="n">protocol</span> <span class="n">data</span> <span class="n">stream</span> <span class="p">(</span><span class="n">code</span> <span class="mi">12</span><span class="p">)</span> <span class="n">at</span> <span class="n">io</span><span class="o">.</span><span class="n">c</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>这通常是您的 rsyncd.conf 中的 path 路径所设的那个目录并不存在所致.请先用 mkdir开设好备份目录.</li>
</ul>

<p>高并发数据实时同步方案小结
1。inotify+rsync 文件级别
2。drbd 文件系统级别
3。 第三方软件的同步功能， mysql, oracle, mongodb
4.。 程序双写
5。业务逻辑解决。（读写分离，备读不到，读主）</p>

            </div>

            <div id="markdown-outline" class="col-lg-3">
            </div>

            <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//magdre.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        </div>
    </div>

    
<footer id="l-footer">
    <div class="container">
        <div class="row">
            <div id="contact" class="col-lg-6 col-lg-offset-1 col-md-6 col-md-offset-1 col-sm-9">
                <h3>CONTACT</h3>
                <div class="row">
                    <address id="address" class="col-lg-6 col-md-6 col-sm-6">
                        China 北京 <br>
                        海淀, 10000<br>
                        上地<br>
                        <br>
                    </address>

                    <ul class="col-lg-6 col-md-6 col-sm-6">
                        <li class="qq"><i class="fa fa-qq"></i> &nbsp;&nbsp;921070747</li>
                        <li class="email"><i class="fa fa-envelope"></i> <a href="mailto:j.k.yulei@gmail.com"> &nbsp;&nbsp;j.k.yulei@gmail.com</a></li>
                        <li class="tel"><i class="fa fa-mobile"></i> <a href="tel:18010073860">&nbsp;&nbsp; 18010073860</a></li>
                        <li class="github"><i class="fa fa-github"></i> <a href="http://magdre.github.io/about"> &nbsp;&nbsp;http://magdre.github.io/about</a></li>
                    </ul>
                </div>
            </div>

            <div id="rss" class="col-lg-2 col-md-2 col-sm-2">
                    <h3>SUBSCRIBE<br></h3>
                <a href="feed.xml">
                    <i class="rss fa fa-rss-square"></i>
                </a>
            </div>
        </div>

        <p id="legal">
            Copyright (c) 2015 sandow | Powered by <a href="http://jekyllrb.com">Jekyll</a> &amp; <a href="http://github.com">GitHub</a> | designed &amp; build by <a href="http://unifreak.github.io">UniFreak</a>
        </p>
    </div>
</footer>

<script type="text/javascript" src="/javascripts/base.js"></script>
<!--

<!-- 百度统计 -->
<script type="text/javascript" src="/javascripts/baidu_statistics.js"></script>

-->


    <script type="text/javascript" src="/javascripts/markdownreader.js"></script>
</body>
</html>
